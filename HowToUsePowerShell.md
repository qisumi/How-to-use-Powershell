# How to use Powershell

## 基本概念

### Cmdlet

Cmdlet是PowerShell环境中实现功能的特殊命令。遵循“动词-名词”模式，例如：`set-childItem`。Cmdlet的输入输出都是对象，而且通过管道输入和输出。Cmdlet处理对象序列和集合时是线性的，同时只处理一个。一些Cmdlet拥有缩写，通常是再Linux中有相同功能的命令。

### 基本术语

1. 别名：将较长的命令赋予较短的别名

2. 环境变量：从操作系统环境中获取变量，例如 `$PATH`.

3. 函数：Powershell脚本中可以创建并使用函数

4. 变量：Powershell脚本中可以定义并使用变量

5. 工作位置：在调用命令时，如果没有显示指定路径，往往使用工作位置的路径

6. 项：包括别名、变量、函数、环境变量、或者文件和目录。

7. 路径名：包括绝对路径、相对路径、特殊路径。绝对路径一般是从`C:/`或者`D:/`开始（Linux上则从`/`开始。相对路径相对于工作位置开始。特殊路径见对应章节。

8. 模块：模块作为一个脚本，可以导出变量和函数，供其他脚本或者shell导入使用。

9. 重载和调用解析：函数名相同但函数签名[^1]不同的函数。PowerShell和大多数支持重载的编程语言一样，会自动按照参数解析。

10. 管道：管道是由管道运算符 `|`分隔的一个或多个命令序列，每个命令接受前置任务的输入，并将输出写入到后续任务。管道末尾处的输出默认会输出到控制台，也可以重定向到文件。

    [^1]: 函数签名：函数名称、参数数量、参数类型统一构成了函数签名

### 通配符表达式

Powershell除了支持正则表达式，也在一些地方支持简单通配符，规则如下：

|          元素          |                             描述                             |
| :--------------------: | :----------------------------------------------------------: |
| 除*、? 和 [ 之外的字符 |                         匹配一个字符                         |
|           *            |     与零个或多个字符匹配。 若要匹配 * 字符，请使用 [*]。     |
|           ?            |        匹配任何单字符。 如需匹配 ? 字符，请使用 [?]。        |
|         [set]          | 匹配 set 中的任意一个字符，不能为空如果 set 以 ] 开头，则右方括号被视为 set 的一部分，下一个右方括号终止 set；否则，第一个右方括号终止 set。如果 set 以 - 开头或结尾，则减号连字符被视为 set 的一部分；否则，它指示一系列连续的 Unicode 代码点，连字符减号两边的字符开始包含在内的范围分隔符。 例如，A-Z 指示 26 个大写英文字母，0-9 指示 10 个十进制数字。 |

### 特殊路径名

对于相对路径，有如下规则：

| 符号 | 说明                   | 相对路径           | 完全限定的路径      |
| :--- | :--------------------- | :----------------- | :------------------ |
| `.`  | 当前工作位置           | `.\System`         | `C:\Windows\System` |
| `..` | 当前工作位置的父级     | `..\Program Files` | `C:\Program Files`  |
| `\`  | 当前工作位置的驱动器根 | `\Program Files`   | `C:\Program Files`  |
| 无   | 无特殊字符             | `System`           | `C:\Windows\System` |

## 变量

### 变量基础

变量以`$`开头，不区分大小写，不包含空格和特殊字符。默认情况下变量的值为`$NULL`。特别的，如果需要在变量名称中使用特殊字符，需要将变量名置于大括号中，例如`{my-variable}`。

变量使用`=`赋值，使用`Clear-Variable`删除变量，也可以将其赋值为`$null`。

对于变量的类型，可以使用`GetType()`方法查看。

默认创建的变量都是局部变量，如果需要创建特殊的变量遵循以下规则：`$global: var`创建全局变量。`$script: var`创建脚本变量。

变量根据用户能否修改、由谁创建分为三种。

|    类型    | 创建者 | 用户读写 |
| :--------: | :----: | :------: |
|  用户变量  |  用户  |   读写   |
|  自动变量  |  系统  |   只读   |
| 首选项变量 |  系统  |   读写   |

### 可变修饰符

1. ReadOnly 可访问，不可修改，可删除
2. Constant 可访问，不可修改，不可删除

### 自动变量

自动变量由系统创建和维护，用户可读不可写。常见的自动变量有：

|              变量               |                      描述                      |
| :-----------------------------: | :--------------------------------------------: |
|               $$                |          最后执行的命令中的最后一部分          |
|               $?                |          最后一个操作执行状态是否成功          |
|               $_                |     在管道对象集合的遍历语法中表示当前对象     |
|            $foreach             |            表示ForEach循环的枚举数             |
|      \$true \$false \$null      |                表示布尔值和空值                |
| \$IsLinux \$IsWindows \$IsMacOS |                    查询平台                    |
|             $input              | 枚举传递给函数的所有输入，仅适用于脚本快和功能 |
|              $Home              |                 用户的Home目录                 |

### 首选项变量

常见的首选项变量有

|         变量         |      默认值      |
| :------------------: | :--------------: |
|   $OutputEncoding    | UTF8Encoding对象 |
| $MaximumHistoryCount |       4096       |

## 运算符

任何列出而不加说明的运算符，其作用和常见编程语言中的类似。

> 在 PowerShell 中存在两种运算符，一种使用符号表达，例如 + - * / 。而另外一种是使用单词来表达运算。这样做的好处是可以避免符号不够用的情况，这些运算符的使用方式为 `-op`。以 `eq`为例：`$a -eq $b`.表示 `a==b`

### 算数运算符

`+` `-` `*` `/` `%` `++` `--`

> 特别说明：这里的乘法运算符还用于数组、字符串的复制。加法用于字符串、数组、哈希表的连接

### 比较运算符

`eq` `ne` `gt` `ge` `lt` `le`

> PowerShell 允许一个集合和一个操作数进行比较。但返回的不是一个布尔数组，而是返回集合的子集，其中的项满足在比较中返回了 `$True`

这是一种常用，但是又不太常用的运算符表达方式，如果你熟悉Latex应该会比较熟悉。其简要含义包括：

1. `eq -> equal` 等于

2. `ne -> not equal` 不等于

3. `gt -> greater than, lt -> less then` 大于或小于

4. `ge -> great equal, lt -> less equal` 大于等于或小于等于

### 赋值运算符

`=` `+=` `-=` `*=` `\=`

### 逻辑运算符

`AND` `OR` `NOT` `XOR`

### 位运算符

`BAND` `BOR` `BXOR`

### 一些用于字符串的运算符

   1. `not` 前缀表示否定
   2. `c` 前缀表示大小写敏感（对非字符串运算不起作用）
   3. `i` 前缀表示显示大小写不敏感（对非字符串运算不起作用）

   ```
       -as           -ccontains     -ceq
       -cge          -cgt           -cle
       -clike        -clt           -cmatch
       -cne          -cnotcontains  -cnotlike
       -cnotmatch    -contains      -creplace
       -csplit       -eq            -ge
       -gt           -icontains     -ieq
       -ige          -igt           -ile
       -ilike        -ilt           -imatch
       -in           -ine           -inotcontains
       -inotlike     -inotmatch     -ireplace
       -is           -isnot         -isplit
       -join         -le            -like
       -lt           -match         -ne
       -notcontains  -notin         -notlike
       -notmatch     -replace       -shl
       -shr          -split
   ```

### 其他运算符

1. 管道运算符：`|`

2. 输出重定向运算符：`>` `>>` 

3. 调用、属性访问运算符：`.`

4. 逗号运算符（用于创建数组）：`,`

5. 字符串操作运算符：`split` `join` `replace` 及其前缀变体

6. 强制类型转换运算符：`[type]`

7. 范围运算符（生成一维数组）：`..` 例如 `1..3`表示`1,2,3`

8. 字符串格式化运算符：`{N[,M][:FormatString]}`

9. 包含运算符：`contains` `in` 及其 `not` 前缀变体。他们的区别在于语义，对于`contains`数组为左操作数，对于`in`则相反。

10. 类型测试运算符 ：`is`

11. 模式匹配运算符：`match` `like` 及其前缀变体。其中`match`支持正则表达式，而`like`支持通配符表达式。

    > 对于 match 和 replace 这种可以接受正则表达式的函数来说，还支持子表达式，在返回的结果中按照顺序（从0开始，按左括号出现的顺序）来排列。对于 replace 来说，使用 $1 \$2 来表达。也可以使用?<name>来定义具名匹配项而不是让 \$matches 中的键成为从0开始的索引

## 字符串

Powershell中的字符串可以由单引号或双引号定义。他们都是`System.String`对象，所以也支持其一切操作。

字符串的常见操作如下所示

```powershell
# 串联的三种方法
$s1+$s2
$s1,$s2 -join ".COM" # 输出{$s1}.COM{$s2}
[System.String]::Concat($s1,$s2)
#子串
$s.SubString(begin,len)
# 格式化内插
$s = "{0:n2,10} {1:p1,-10}" -f $s1,$s2 # :n2表示保留2位小数 :p1先保留小数点后一位再转换为百分数，,10 ,-10表示向右(左)对齐并补足10位。
# 替换
$s.Replace(s1,s2) 
$s -replace s1,s2 # 大小写不敏感，使用creplace则大小写敏感
$s -creplace s1,s2
# 包含
$s. -match $s1 # 大小写不敏感, 使用cmatch则大小写敏感
$s.Contains($s1) # 大小写敏感
# 过滤器
$s -like "3.14*" # -like支持通配符
# 分割
$s.Split($s1,[StringSplitOptions]::RemoveEmptyEntries) # 指定删除空的切割结果
# 比较
$s1.CompareTo($s1)
# 长度
$s.Length
# 插入
$s.Insert(begin, $s1)
# 删除
$s.Remove(begin, length)
# join
"10","20","30" -join(",") # 10,20,30
```

### 字符串格式化

```powershell
# 字符串格式化的详细规则
`$i` = 10; $j = 12
"{2} <= {0} + {1}\`n" -f $i,$j,($i+$j)  # 22 <= 10 + 12
">{0,3}<" -f 5                          # > 5<
">{0,-3}<" -f 5                         # >5 <
">{0,3:000}<" -f 5                      # >005<
">{0,5:0.00}<" -f 5.0                   # > 5.00<
">{0:C}<" -f 1234567.888                # >$1,234,567.89<
">{0:C}<" -f -1234.56                   # >($1,234.56)<
">{0,12:e2}<" -f 123.456e2              # > 1.23e+004<
">{0,-12:p}<" -f -0.252                 # >-25.20 % <
$format = ">{0:x8}<"
$format -f 123455                       # >0001e23f<
```

## 数组

在PowerShell中声明数组，使用逗号分割的多个值给变量赋值。默认情况下数组是多态数组，不要求元素具有相同的类型。*同时，PowerShell中的类型是引用类型，这意味着简单的赋值不会创建新的对象。*

`$var = v1, v2, v3,...,vn`

在PowerSehll中访问数组元素，使用方括号，下标从`0`开始，支持负数、范围。对于多维数组，PowerShell使用类似Python的语法，即`arr[0,0]`这种形式。

```powershell
$arr = 1,2,3,4,5 # 创建一维数组
$mat = New-Object 'object[,]' 2,2 # 创建二维数组
# 一般访问
$arr[1]
# 访问范围
$arr[1..4]
# 负数所以
$arr[-1]
```

对于数组，可以使用如下便携操作。

```powershell
$a = 1,2,3,4
# 获取数组长度
$a.Lenght
# 添加元素
$a += 1
# 初始化空数组
$a = @()
# 删除数组元素：PowerShell不直接支持删除数组，需要重新创建
$a = ($a[1] $a[2] $a[3])
# 约束元素类型
$a = [int[]](1,2,3)
```

## 哈希表

在PowerShell中，哈希表分为无序或有序两种。分别使用如下方法创建

```powershell
$variable_name = @{ <key1> = <value1> ; < key2> = <value2> ; ..... ; < keyN> = <valueN>;}
$variable_name = [ordered] @{ < key1> = <value1> ; < key2> = <value2> ; ..... ; < keyN> = <valueN>;}
```

哈希表有一些属性

```powershell
$hash.keys
$hash.values
$hash.count
```

哈希表的CRUD

```powershell
# 读、改
$hash["key"] = newValue
$hash.Key = newValue
# 增
$hash.Add(key,value)
# 删
$hash.Remove(key)
# 遍历
$hash.GetEnumerator() | Sort-Object -Property key
```

